openapi: 3.0.3
info:
  title: Industry Monitor API
  description: |
    萌拉数据采集系统 API 文档
    
    ## 概述
    该系统提供行业数据采集、缓存、查询功能，支持蓝海/热销/潜力行业分析、行业趋势等。
    
    ## 认证
    管理接口需要启用 `ENABLE_PANEL_ADMIN=1` 环境变量（开发环境默认开启）
    
    ## 缓存层级
    - L1: 本地内存缓存
    - L2: Redis 缓存
    - L3: MongoDB 持久化
    - fresh: 实时采集
    
    响应头 `X-MengLa-Source` 表示数据来源
  version: 0.1.0
  contact:
    name: MengLa Team

servers:
  - url: http://localhost:8000
    description: 本地开发服务器
  - url: https://mengla-collect-test.frp.ggss.club
    description: FRP 公网穿透地址

tags:
  - name: Health
    description: 健康检查
  - name: Categories
    description: 类目管理
  - name: MengLa Query
    description: 萌拉数据查询（核心业务）
  - name: Panel
    description: 面板配置与任务管理
  - name: Admin
    description: 管理与运维接口
  - name: Webhook
    description: 外部回调接口

paths:
  /:
    get:
      tags: [Health]
      summary: 服务状态
      operationId: root
      responses:
        '200':
          description: 服务运行中
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Industry Monitor API running"

  /health:
    get:
      tags: [Health]
      summary: 健康检查
      operationId: healthCheck
      responses:
        '200':
          description: 服务健康
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /api/categories:
    get:
      tags: [Categories]
      summary: 获取类目树
      description: 返回完整的类目层级结构，数据来源于 backend/category.json
      operationId: getCategories
      responses:
        '200':
          description: 类目树列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'

  /api/mengla/query:
    post:
      tags: [MengLa Query]
      summary: 统一查询接口
      description: |
        萌拉数据统一查询入口，根据 action 参数返回不同类型数据：
        - high: 蓝海 Top 行业
        - hot: 热销 Top 行业
        - chance: 潜力 Top 行业
        - industryViewV2: 行业区间分布
        - industryTrendRange: 行业趋势
      operationId: menglaQuery
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MengLaQueryBody'
      responses:
        '200':
          description: 查询成功
          headers:
            X-MengLa-Source:
              description: 数据来源 (l1/l2/l3/fresh)
              schema:
                type: string
                enum: [l1, l2, l3, fresh]
            X-MengLa-Trend-Partial:
              description: 趋势数据部分返回标记 (requested,found)
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MengLaResponseData'
        '400':
          $ref: '#/components/responses/BadRequest'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '504':
          $ref: '#/components/responses/Timeout'

  /api/mengla/high:
    post:
      tags: [MengLa Query]
      summary: 蓝海 Top 行业
      description: 查询蓝海（低竞争高潜力）Top 行业列表
      operationId: menglaHigh
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MengLaQueryParamsBody'
      responses:
        '200':
          description: 蓝海行业数据
          headers:
            X-MengLa-Source:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HighListResponse'

  /api/mengla/hot:
    post:
      tags: [MengLa Query]
      summary: 热销 Top 行业
      description: 查询热销 Top 行业列表
      operationId: menglaHot
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MengLaQueryParamsBody'
      responses:
        '200':
          description: 热销行业数据
          headers:
            X-MengLa-Source:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HotListResponse'

  /api/mengla/chance:
    post:
      tags: [MengLa Query]
      summary: 潜力 Top 行业
      description: 查询潜力 Top 行业列表
      operationId: menglaChance
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MengLaQueryParamsBody'
      responses:
        '200':
          description: 潜力行业数据
          headers:
            X-MengLa-Source:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChanceListResponse'

  /api/mengla/industry-view:
    post:
      tags: [MengLa Query]
      summary: 行业区间分布
      description: 查询行业销量、GMV、价格、品牌占比等区间分布
      operationId: menglaIndustryView
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MengLaQueryParamsBody'
      responses:
        '200':
          description: 行业区间分布数据
          headers:
            X-MengLa-Source:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IndustryViewResponse'

  /api/mengla/industry-trend:
    post:
      tags: [MengLa Query]
      summary: 行业趋势
      description: 查询指定时间范围内的行业趋势数据
      operationId: menglaIndustryTrend
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MengLaQueryParamsBody'
      responses:
        '200':
          description: 行业趋势数据
          headers:
            X-MengLa-Source:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IndustryTrendResponse'

  /api/industry/daily:
    get:
      tags: [MengLa Query]
      summary: 按日期查询行业数据
      description: 从 MongoDB/Redis 查询指定日期的行业数据
      operationId: getIndustryDaily
      parameters:
        - name: date
          in: query
          required: true
          description: 日期格式 YYYYMMDD
          schema:
            type: string
            example: "20260201"
      responses:
        '200':
          description: 行业数据列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/IndustryDailyDoc'

  /panel/config:
    get:
      tags: [Panel]
      summary: 获取面板配置
      description: 获取行业面板的模块配置和布局设置
      operationId: getPanelConfig
      responses:
        '200':
          description: 面板配置
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PanelConfig'
    put:
      tags: [Panel]
      summary: 更新面板配置
      description: 更新行业面板的模块配置和布局设置（需要管理权限）
      operationId: updatePanelConfig
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PanelConfigUpdate'
      responses:
        '200':
          description: 更新后的配置
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PanelConfig'
        '403':
          $ref: '#/components/responses/Forbidden'

  /panel/tasks:
    get:
      tags: [Panel]
      summary: 获取任务列表
      description: 获取可执行的采集任务列表（需要管理权限）
      operationId: listPanelTasks
      responses:
        '200':
          description: 任务列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PanelTask'
        '403':
          $ref: '#/components/responses/Forbidden'

  /panel/tasks/{task_id}/run:
    post:
      tags: [Panel]
      summary: 执行任务
      description: 触发指定任务在后台执行（需要管理权限）
      operationId: runPanelTask
      parameters:
        - name: task_id
          in: path
          required: true
          description: 任务ID
          schema:
            type: string
            enum:
              - mengla_granular
              - mengla_single_day
              - daily_collect
              - monthly_collect
              - quarterly_collect
              - yearly_collect
              - backfill_check
      responses:
        '200':
          description: 任务已启动
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskStartedResponse'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: 任务不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /panel/data/fill:
    post:
      tags: [Panel]
      summary: 补数任务
      description: 后台填充指定时间范围内的缺失数据（需要管理权限）
      operationId: panelDataFill
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PanelDataFillRequest'
      responses:
        '200':
          description: 补数任务已启动
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FillStartedResponse'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/webhook/mengla-notify:
    get:
      tags: [Webhook]
      summary: Webhook 健康检查
      description: 外部采集服务用于测试 webhook 可达性
      operationId: webhookHealth
      responses:
        '200':
          description: Webhook 就绪
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
                  message:
                    type: string
                    example: "webhook endpoint is ready"
    post:
      tags: [Webhook]
      summary: 接收采集回调
      description: 外部采集服务完成任务后的回调入口
      operationId: webhookNotify
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookPayload'
      responses:
        '200':
          description: 回调处理成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
        '400':
          description: 缺少 executionId
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/mengla/status:
    post:
      tags: [Admin]
      summary: 查询数据存在状态
      description: 查询指定类目、时间范围、颗粒度下各接口数据是否存在
      operationId: getMenglaStatus
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MengLaStatusRequest'
      responses:
        '200':
          description: 数据状态
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MengLaStatusResponse'

  /admin/mengla/enqueue-full-crawl:
    post:
      tags: [Admin]
      summary: 创建爬取任务队列
      description: 创建队列化的全量爬取任务（需要管理权限）
      operationId: enqueueFullCrawl
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EnqueueFullCrawlRequest'
      responses:
        '200':
          description: 任务已入队
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CrawlJobEnqueuedResponse'
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/backfill:
    post:
      tags: [Admin]
      summary: 历史补录
      description: 触发历史数据补录任务
      operationId: triggerBackfill
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BackfillRequest'
      responses:
        '200':
          description: 补录已启动
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "backfill started"
                  start_date:
                    type: string
                  end_date:
                    type: string

  /admin/metrics:
    get:
      tags: [Admin]
      summary: 获取采集指标
      operationId: getMetrics
      responses:
        '200':
          description: 采集指标统计
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/metrics/latency:
    get:
      tags: [Admin]
      summary: 获取延迟百分位
      operationId: getLatencyStats
      responses:
        '200':
          description: 延迟百分位统计
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/alerts:
    get:
      tags: [Admin]
      summary: 获取告警状态
      operationId: getAlerts
      responses:
        '200':
          description: 活跃告警和规则状态
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertsResponse'
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/alerts/history:
    get:
      tags: [Admin]
      summary: 获取告警历史
      operationId: getAlertHistory
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: 告警历史列表
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  additionalProperties: true
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/alerts/check:
    post:
      tags: [Admin]
      summary: 手动触发告警检查
      operationId: checkAlerts
      responses:
        '200':
          description: 检查结果
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/alerts/silence:
    post:
      tags: [Admin]
      summary: 静默告警规则
      operationId: silenceAlertRule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SilenceRuleRequest'
      responses:
        '200':
          description: 规则已静默
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: 规则不存在

  /admin/cache/stats:
    get:
      tags: [Admin]
      summary: 获取缓存统计
      operationId: getCacheStats
      responses:
        '200':
          description: 缓存统计
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CacheStatsResponse'
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/cache/warmup:
    post:
      tags: [Admin]
      summary: 触发缓存预热
      operationId: triggerCacheWarmup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CacheWarmupRequest'
      responses:
        '200':
          description: 预热已启动
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Cache warmup started"
                  limit:
                    type: integer
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/cache/clear-l1:
    post:
      tags: [Admin]
      summary: 清空 L1 缓存
      operationId: clearL1Cache
      responses:
        '200':
          description: 缓存已清空
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "L1 cache cleared"
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/circuit-breakers:
    get:
      tags: [Admin]
      summary: 获取熔断器状态
      operationId: getCircuitBreakers
      responses:
        '200':
          description: 熔断器状态
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/circuit-breakers/reset:
    post:
      tags: [Admin]
      summary: 重置熔断器
      operationId: resetCircuitBreakers
      responses:
        '200':
          description: 熔断器已重置
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "All circuit breakers reset"
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/system/status:
    get:
      tags: [Admin]
      summary: 获取系统综合状态
      operationId: getSystemStatus
      responses:
        '200':
          description: 系统状态
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemStatusResponse'
        '403':
          $ref: '#/components/responses/Forbidden'

components:
  schemas:
    # ==================== 基础响应 ====================
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: "ok"

    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
          example: "error message"

    # ==================== 类目 ====================
    Category:
      type: object
      properties:
        catId:
          type: integer
          example: 17027494
        catName:
          type: string
          example: "Women's Clothing"
        catNameCn:
          type: string
          example: "女装"
        children:
          type: array
          items:
            $ref: '#/components/schemas/Category'

    # ==================== MengLa 查询 ====================
    MengLaQueryBody:
      type: object
      required: [action]
      properties:
        action:
          type: string
          enum: [high, hot, chance, industryViewV2, industryTrendRange]
          description: 查询类型
        product_id:
          type: string
          description: 产品ID（可选）
        catId:
          type: string
          description: 类目ID，必须在 category.json 中存在
          example: "17027494"
        dateType:
          type: string
          enum: [DAY, MONTH, QUARTER, YEAR]
          description: 时间颗粒度
        timest:
          type: string
          description: 时间戳
          example: "2026-02"
        starRange:
          type: string
          description: 开始日期
          example: "2026-01-01"
        endRange:
          type: string
          description: 结束日期
          example: "2026-01-31"
        extra:
          type: object
          description: 额外参数

    MengLaQueryParamsBody:
      type: object
      properties:
        product_id:
          type: string
        catId:
          type: string
          example: "17027494"
        dateType:
          type: string
          enum: [DAY, MONTH, QUARTER, YEAR]
        timest:
          type: string
          example: "2026-02"
        starRange:
          type: string
          example: "2026-01-01"
        endRange:
          type: string
          example: "2026-01-31"
        extra:
          type: object

    # ==================== MengLa 响应数据 ====================
    HighListRow:
      type: object
      properties:
        catId1:
          type: integer
          description: 一级类目ID
        catName:
          type: string
          description: 类目名称（英文）
        catNameCn:
          type: string
          description: 类目名称（中文）
        skuNum:
          type: integer
          description: SKU 数量
        saleSkuNum:
          type: integer
          description: 动销 SKU 数量
        saleRatio:
          type: number
          format: float
          description: 动销率
        monthSales:
          type: integer
          description: 月销量
        monthGmv:
          type: number
          description: 月 GMV（美元）
        monthGmvRmb:
          type: number
          description: 月 GMV（人民币）
        brandGmvRating:
          type: number
          format: float
          description: 品牌 GMV 占比
        topGmvRating:
          type: number
          format: float
          description: Top GMV 占比

    MengLaResponseData:
      type: object
      properties:
        highList:
          $ref: '#/components/schemas/ListWrapper'
        hotList:
          $ref: '#/components/schemas/ListWrapper'
        chanceList:
          $ref: '#/components/schemas/ListWrapper'
        industryViewV2List:
          $ref: '#/components/schemas/IndustryViewData'
        industryTrendRange:
          $ref: '#/components/schemas/TrendRangeData'
        secondaryCategories:
          type: array
          items:
            $ref: '#/components/schemas/Category'

    ListWrapper:
      type: object
      properties:
        code:
          type: integer
          example: 0
        data:
          type: object
          properties:
            list:
              type: array
              items:
                $ref: '#/components/schemas/HighListRow'
            pageNo:
              type: integer
            pageSize:
              type: integer

    HighListResponse:
      type: object
      properties:
        highList:
          $ref: '#/components/schemas/ListWrapper'
        secondaryCategories:
          type: array
          items:
            $ref: '#/components/schemas/Category'

    HotListResponse:
      type: object
      properties:
        hotList:
          $ref: '#/components/schemas/ListWrapper'
        secondaryCategories:
          type: array
          items:
            $ref: '#/components/schemas/Category'

    ChanceListResponse:
      type: object
      properties:
        chanceList:
          $ref: '#/components/schemas/ListWrapper'
        secondaryCategories:
          type: array
          items:
            $ref: '#/components/schemas/Category'

    IndustryViewData:
      type: object
      properties:
        data:
          type: object
          properties:
            industrySalesRangeDtoList:
              type: array
              items:
                $ref: '#/components/schemas/RangeItem'
            industryGmvRangeDtoList:
              type: array
              items:
                $ref: '#/components/schemas/RangeItem'
            industryPriceRangeDtoList:
              type: array
              items:
                $ref: '#/components/schemas/RangeItem'
            industryBrandRateDtoList:
              type: array
              items:
                $ref: '#/components/schemas/RangeItem'

    IndustryViewResponse:
      type: object
      properties:
        industryViewV2List:
          $ref: '#/components/schemas/IndustryViewData'
        secondaryCategories:
          type: array
          items:
            $ref: '#/components/schemas/Category'

    RangeItem:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
          example: "0-10"
        itemCount:
          type: integer
        sales:
          type: integer
        gmv:
          type: number
        itemCountRate:
          type: number
          format: float

    TrendPoint:
      type: object
      properties:
        timest:
          type: string
          example: "2026-02-01"
        salesSkuCount:
          type: integer
        monthSales:
          type: integer
        monthGmv:
          type: number
        currentDayPrice:
          type: number

    TrendRangeData:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/TrendPoint'

    IndustryTrendResponse:
      type: object
      properties:
        industryTrendRange:
          $ref: '#/components/schemas/TrendRangeData'
        secondaryCategories:
          type: array
          items:
            $ref: '#/components/schemas/Category'

    IndustryDailyDoc:
      type: object
      properties:
        _id:
          type: string
        granularity:
          type: string
        period_key:
          type: string
        action:
          type: string
        data:
          type: object

    # ==================== Panel ====================
    PanelConfig:
      type: object
      properties:
        modules:
          type: array
          items:
            $ref: '#/components/schemas/PanelModule'
        layout:
          type: object
          properties:
            defaultPeriod:
              type: string
              enum: [day, month, quarter, year]
            showRankPeriodSelector:
              type: boolean

    PanelModule:
      type: object
      properties:
        id:
          type: string
          example: "overview"
        name:
          type: string
          example: "行业总览"
        enabled:
          type: boolean
        order:
          type: integer
        props:
          type: object

    PanelConfigUpdate:
      type: object
      properties:
        modules:
          type: array
          items:
            type: object
        layout:
          type: object

    PanelTask:
      type: object
      properties:
        id:
          type: string
          example: "daily_collect"
        name:
          type: string
          example: "每日主采集"
        description:
          type: string
          example: "采集当天的 day 颗粒度数据"

    TaskStartedResponse:
      type: object
      properties:
        message:
          type: string
          example: "task started"
        task_id:
          type: string

    PanelDataFillRequest:
      type: object
      required: [granularity, startDate, endDate]
      properties:
        granularity:
          type: string
          enum: [day, month, quarter, year]
        startDate:
          type: string
          format: date
          example: "2026-01-01"
        endDate:
          type: string
          format: date
          example: "2026-01-31"
        actions:
          type: array
          items:
            type: string
            enum: [high, hot, chance, industryViewV2, industryTrendRange]

    FillStartedResponse:
      type: object
      properties:
        message:
          type: string
          example: "fill started"
        granularity:
          type: string
        startDate:
          type: string
        endDate:
          type: string
        periodKeyCount:
          type: integer

    # ==================== Webhook ====================
    WebhookPayload:
      type: object
      required: [executionId]
      properties:
        executionId:
          type: string
          description: 执行ID
        resultData:
          type: object
          description: 采集结果数据
        data:
          type: object
          properties:
            executionId:
              type: string

    # ==================== Admin ====================
    MengLaStatusRequest:
      type: object
      required: [granularity, startDate, endDate]
      properties:
        catId:
          type: string
        granularity:
          type: string
          enum: [day, month, quarter, year]
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        actions:
          type: array
          items:
            type: string

    MengLaStatusResponse:
      type: object
      properties:
        catId:
          type: string
        granularity:
          type: string
        startDate:
          type: string
        endDate:
          type: string
        status:
          type: object
          additionalProperties:
            type: object
            additionalProperties:
              type: boolean
          example:
            high:
              "20260101": true
              "20260102": false
            hot:
              "20260101": true

    EnqueueFullCrawlRequest:
      type: object
      required: [startDate, endDate]
      properties:
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        granularities:
          type: array
          items:
            type: string
            enum: [day, month, quarter, year]
        actions:
          type: array
          items:
            type: string
        catId:
          type: string

    CrawlJobEnqueuedResponse:
      type: object
      properties:
        message:
          type: string
          example: "crawl job enqueued"
        jobId:
          type: string
        startDate:
          type: string
        endDate:
          type: string

    BackfillRequest:
      type: object
      required: [start_date, end_date]
      properties:
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
        interfaces:
          type: array
          items:
            type: string

    MetricsResponse:
      type: object
      properties:
        total_requests:
          type: integer
        success_count:
          type: integer
        error_count:
          type: integer
        avg_latency_ms:
          type: number
        cache_hit_rate:
          type: number

    AlertsResponse:
      type: object
      properties:
        active:
          type: array
          items:
            type: object
        rules:
          type: object

    SilenceRuleRequest:
      type: object
      required: [rule_name]
      properties:
        rule_name:
          type: string
        duration_minutes:
          type: integer
          default: 60

    CacheStatsResponse:
      type: object
      properties:
        l1_size:
          type: integer
        l1_hits:
          type: integer
        l1_misses:
          type: integer
        l2_hits:
          type: integer
        l2_misses:
          type: integer

    CacheWarmupRequest:
      type: object
      properties:
        actions:
          type: array
          items:
            type: string
        cat_ids:
          type: array
          items:
            type: string
        granularities:
          type: array
          items:
            type: string
        limit:
          type: integer
          default: 100

    SystemStatusResponse:
      type: object
      properties:
        metrics:
          $ref: '#/components/schemas/MetricsResponse'
        cache:
          $ref: '#/components/schemas/CacheStatsResponse'
        alerts:
          type: object
          properties:
            active_count:
              type: integer
            rules:
              type: object
        circuit_breakers:
          type: object
        scheduler:
          type: object
          properties:
            running:
              type: boolean
            jobs:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                  name:
                    type: string
                  next_run:
                    type: string

  responses:
    BadRequest:
      description: 请求参数错误
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            detail: "catId 必须在 backend/category.json 中"

    Forbidden:
      description: 权限不足（管理功能未启用）
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            detail: "Panel admin is disabled. Set ENABLE_PANEL_ADMIN=1 to enable."

    ServiceUnavailable:
      description: 服务不可用
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            detail: "采集服务不可达，请检查 COLLECT_SERVICE_URL 与网络"

    Timeout:
      description: 请求超时
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            detail: "mengla query timeout"
